#!/bin/bash

function gen1() {
    echo "(module"
    echo "  (func (export \"main\") (param $1) (result $2)"
    echo "    ($3 (local.get 0))"
    echo "  )"
    echo ")"
}

function gen2() {
    echo "(module"
    echo "  (func (export \"main\") (param $1 $2) (result $3)"
    echo "    ($4 (local.get 0) (local.get 1))"
    echo "  )"
    echo ")"
}

i32_min=-2147483648
i32_max=2147483647
pt_zero=".000000"

function BEGIN() {
    export INSTR=$1
    SUFFIX=""
    for s in $SIG; do
	if [ "$s" = "f64" ]; then
	    SUFFIX="_d"
	else
	    SUFFIX=""
	fi
    done
    export NAME=${1}0${SUFFIX}
    $SIG $INSTR > $NAME.wat
    rm -f $NAME.runs
}

function t() {
    echo "$@" >> $NAME.runs
}

function END() {
    # do nothing
    NOTHING=0
}

##############################################################################
SIG="gen1 i32 i32"

BEGIN i32.eqz
t 0 = 1
t 1 = 0
t $i32_min = 0
t 897234987 = 0

BEGIN i32.clz
t 0 = 32
t 1 = 31
t $i32_min = 0
t 897234987 = 2
t 65000 = 16

BEGIN i32.ctz
t 0 = 32
t 1 = 0
t $i32_min = 31
t 897234987 = 0
t 65536 = 16

BEGIN i32.popcnt
t 0 = 0
t 1 = 1
t 2 = 1
t 89721348 = 9
t -8934345 = 23
t $i32_min = 1

BEGIN i32.extend8_s
t 0 = 0
t 1 = 1
t $i32_min = 0
t 897234987 = 43
t 128 = -128

BEGIN i32.extend16_s
t 0 = 0
t 1 = 1
t $i32_min = 0
t 897234987 = -18389
t 128 = 128
t 32768 = -32768


##############################################################################
SIG="gen2 i32 i32 i32"
BEGIN i32.eq
t 0 0 = 1
t 1 0 = 0
t 0 1 = 0
t 5555 5555 = 1
t -87239487 -8723487 = 0

BEGIN i32.ne
t 0 0 = 0
t 1 0 = 1
t 0 1 = 1
t 5555 5555 = 0
t -87239487 -8723487 = 1

BEGIN i32.lt_s
t -1 0 = 1
t -1 -2 = 0
t -55 -55 = 0
t 30000000 40000000 = 1
t -30000000 -40000000 = 0
t $i32_min -1 = 1
t $i32_min -2147483647 = 1
t 55 54 = 0
t 55 55 = 0
t 55 56 = 1
t -56 -55 = 1
t -55 56 = 1

BEGIN i32.lt_u
t -1 0 = 0
t -1 -2 = 0
t -55 -55 = 0
t 30000000 40000000 = 1
t -30000000 -40000000 = 0
t $i32_min -1 = 1
t $i32_min -2147483647 = 1
t 55 54 = 0
t 55 55 = 0
t 55 56 = 1
t -56 -55 = 1
t -55 56 = 0

BEGIN i32.gt_s
t -1 0 = 0
t -1 -2 = 1
t -55 -55 = 0
t 30000000 40000000 = 0
t -30000000 -40000000 = 1
t $i32_min -1 = 0
t $i32_min -2147483647 = 0
t 55 54 = 1
t 55 55 = 0
t 55 56 = 0
t -56 -55 = 0
t -55 56 = 0

BEGIN i32.gt_u
t -1 0 = 1
t -1 -2 = 1
t -55 -55 = 0
t 30000000 40000000 = 0
t -30000000 -40000000 = 1
t $i32_min -1 = 0
t $i32_min -2147483647 = 0
t 55 54 = 1
t 55 55 = 0
t 55 56 = 0
t -56 -55 = 0
t -55 56 = 1

BEGIN i32.le_s
t -1 0 = 1
t -2 -3 = 0
t -55 -55 = 1
t 50000000 60000000 = 1
t -50000000 -60000000 = 0
t $i32_min -1 = 1
t $i32_min -2147483647 = 1
t 55 54 = 0
t 55 55 = 1
t 55 56 = 1
t -56 -55 = 1
t -55 56 = 1

BEGIN i32.le_u
t -1 0 = 0
t -3 -4 = 0
t -55 -55 = 1
t 50000000 60000000 = 1
t -50000000 -60000000 = 0
t $i32_min -1 = 1
t $i32_min -2147483647 = 1
t 55 54 = 0
t 55 55 = 1
t 55 56 = 1
t -56 -55 = 1
t -55 56 = 0

BEGIN i32.ge_s
t -1 0 = 0
t -1 -2 = 1
t -55 -55 = 1
t 30000000 40000000 = 0
t -30000000 -40000000 = 1
t $i32_min -1 = 0
t $i32_min -2147483647 = 0
t 55 54 = 1
t 55 55 = 1
t 55 56 = 0
t -56 -55 = 0
t -55 56 = 0

BEGIN i32.ge_u
t -1 0 = 1
t -5 -6 = 1
t -55 -55 = 1
t 30000000 40000000 = 0
t -20000000 -40000000 = 1
t $i32_min -1 = 0
t $i32_min -2147483647 = 0
t 55 54 = 1
t 55 55 = 1
t 55 56 = 0
t -56 -55 = 0
t -55 56 = 1

BEGIN i32.add
t 8 9 = 17
t 33 44 = 77
t 111 222 = 333
t 2222 3333 = 5555
t 111111111 666666666 = 777777777
t $i32_min $i32_min = 0
t -2129587951 -2093796557 = 71582788

BEGIN i32.sub
t 8 9 = -1
t 33 44 = -11
t 111 222 = -111
t 2222 3333 = -1111
t 111111111 666666666 = -555555555
t $i32_min $i32_min = 0
t -2129587951 -2093796557 = -35791394
t 2000000000 1 = 1999999999

BEGIN i32.mul
t 8 9 = 72
t 33 44 = 1452
t 111 222 = 24642
t 2222 3333 = 7405926
t 111111111 666666666 = 1332460582
t $i32_min $i32_min = 0
t -2129587951 -2093796557 = 909101411
t 2000000000 1 = 2000000000
t 2000000000 3 = 1705032704

BEGIN i32.div_s
t 5555 1111 = 5
t -77777777 11111111 = -7
t -77777777 11111 = -7000
t $i32_min -1 = !trap
t 333 0 = !trap

BEGIN i32.div_u
t 5555 1111 = 5
t -77777777 11111111 = 379
t -77777777 11111 = 379550
t $i32_min -1 = 0
t 3553 0 = !trap

BEGIN i32.rem_s
t 99 10 = 9
t 107 -10 = 7
t -107 -10 = -7
t -107 10 = -7
t 1 0 = !trap
t 5559823 1 = 0
t $i32_min -1 = 0
t 876345 -1 = 0

BEGIN i32.rem_u
t 13338 10 = 8
t 99 -3 = 99
t 1 0 = !trap
t 555 1 = 0
t $i32_min -1 = $i32_min

BEGIN i32.and
t 876234 982134 = 810050
t 897234 0 = 0
t 89273498 -1 = 89273498
t -555 $i32_min = $i32_min

BEGIN i32.or
t 876234 982134 = 1048318
t 897234 0 = 897234
t 89273498 -1 = -1
t -555 $i32_min = -555

BEGIN i32.xor
t 876234 982134 = 238268
t 897234 0 = 897234
t 89273498 -1 = -89273499
t -555 $i32_min = 2147483093

BEGIN i32.shl
t 1044480 0 = 1044480
t 1044480 32 = 1044480
t 8972134 23 = -1291845632
t -1 31 = $i32_min
t 1044480 36 = 16711680

BEGIN i32.shr_s
t 1044480 0 = 1044480
t 1044480 32 = 1044480
t 8972134 13 = 1095
t -8972134 13 = -1096
t 268435455 27 = 1
t -256 4 = -16
t 1044480 36 = 65280

BEGIN i32.shr_u
t 1044480 0 = 1044480
t 1044480 32 = 1044480
t 8972134 13 = 1095
t -8972134 13 = 523192
t -1 31 = 1
t 1044480 36 = 65280

BEGIN i32.rotl
t 1044480 0 = 1044480
t 1044480 32 = 1044480
t 8972134 13 = 485277713
t -8972134 13 = -485269522
t -1412628189 36 = -1127214534

BEGIN i32.rotr
t 1044480 0 = 1044480
t 1044480 32 = 1044480
t 8972134 13 = 993002567
t -8972134 13 = -992478280
t -1412628189 36 = 985452562

END

##############################################################################
SIG="gen2 f64 f64 i32"
BEGIN f64.eq
t 0d 1d = 0
t 1.25d -1.25d = 0
t 55.55d 55.5d = 0
# TODO: nans and infinities

BEGIN f64.ne
t 0d 1d = 1
t 1.25d -1.25d = 1
t 55.55d 55.5d = 1

BEGIN f64.lt
t 0d 1d = 1
t 0d -1d = 0
t 0.25d 0.5d = 1
t 333.5d 333.5d = 0

BEGIN f64.gt
t 0d 1d = 0
t 0d -1d = 1
t 0.25d 0.5d = 0
t 333.5d 333.5d = 0

BEGIN f64.le
t 0d 1d = 1
t 0d -1d = 0
t 0.25d 0.5d = 1
t 333.5d 333.5d = 1

BEGIN f64.ge
t 0d 1d = 0
t 0d -1d = 1
t 0.25d 0.5d = 0
t 333.5d 333.5d = 1

##############################################################################
SIG="gen2 f64 f64 f64"
BEGIN f64.add
t 0d 1d = 1.000000
t 0.25d -1.75d = -1.500000
t 489728.83423d -782374.47d = -292645.635770
# TODO: nans and infinities

BEGIN f64.sub
t 0d 1d = -1$pt_zero
t 0.25d -1.75d = 2$pt_zero
t 489728.83423d -782374.47d = 1272103.304230

BEGIN f64.mul
t 0d 1d = 0$pt_zero
t 0.25d -1.75d = -0.437500
t 3000d -70000d = -210000000.000000

BEGIN f64.div
#TODO: nans and infinities t 0d 0d = nan
t 489728.83423d -782374.47d = -0.625952
t 7000000000000d 800000000000d = 8.750000

##############################################################################
SIG="gen1 f64 i32"
BEGIN i32.trunc_f64_s
t 0d = 0
t 0.9d = 0
t -0.9d = 0
t 1d = 1
t -87234d = -87234
t ${i32_min}d = $i32_min
t -3000000000d = !trap
t 3000000000d = !trap

BEGIN i32.trunc_f64_u
t 0d = 0
t 1d = 1
t 0.9d = 0
t -0.9d = 0
t -87234d = !trap
t $i32_min = !trap
t 3000000000d = -1294967296

##############################################################################
SIG="gen1 i32 f64"
BEGIN f64.convert_i32_s
t 0 = 0$pt_zero
t 1 = 1$pt_zero
t -87234 = -87234$pt_zero
t $i32_min = $i32_min$pt_zero

BEGIN f64.convert_i32_u
t 0 = 0$pt_zero
t 1 = 1$pt_zero
t -87234 = 4294880062$pt_zero
t $i32_min = 2147483648$pt_zero

END
